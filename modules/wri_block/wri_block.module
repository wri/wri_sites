<?php

/**
 * @file
 * Functions for wri custom blocks.
 */

use Drupal\Component\Utility\Html;
use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_preprocess_block().
 */
function wri_block_preprocess_block(array &$variables) {
  // Custom Blocks added through layout builder are missing classes and
  // contextual links. This preprocess hook adds them back.
  // @see https://www.drupal.org/project/drupal/issues/2407761#comment-13414693
  if (isset($variables["content"]["#block_content"])) {
    // Add the block bundle.
    $variables['attributes']['class'][] = 'block-content--type-' . Html::getClass($variables["derivative_plugin_id"]);
    // We're only adding contextual links for reusable blocks. Might be nice
    // To add a link to the layout builder for non-contextuals...
    if ($variables["content"]["#block_content"]->isReusable() && isset($variables["content"]["#contextual_links"])) {
      $variables['attributes']['class'][] = 'contextual-region';

      $variables['title_suffix']['contextual_links'] = [
        '#type' => 'contextual_links_placeholder',
        '#id' => _contextual_links_to_id($variables["content"]['#contextual_links']),
      ];
    }

    // Cheap way to get the block label into the block_content render.
    if (isset($variables["content"]["block_label"][0][0])) {
      $variables["content"]["block_label"][0][0]['#markup'] = $variables["label"];
      unset($variables['label']);
    }

  }

  // Add title_attributes from this block into the title_attributes variable.
  if (isset($variables['content']['#title_attributes'])) {
    foreach ($variables['content']['#title_attributes'] as $key => $title_attribute) {
      if (isset($variables['title_attributes'][$key])) {
        $variables['title_attributes'][$key] = array_merge($variables['title_attributes'][$key], $title_attribute);
      }
      else {
        $variables['title_attributes'][$key] = $title_attribute;
      }
    }
  }
}

/**
 * Implements hook_form_alter().
 */
function wri_block_form_alter(&$variables) {
  // If the destination of this request is an entity browser, don't show the
  // "Save and configure" button.
  $destination = \Drupal::request()->get('destination');
  if (isset($variables["actions"]["configure_block"]) && str_contains($destination, '/entity-browser/iframe/block')) {
    $variables["actions"]["configure_block"]['#access'] = FALSE;
  }
}

/**
 * Alter the Entity Embed dialog (final step, webform blocks only).
 */
function wri_block_form_entity_embed_dialog_alter(array &$form, FormStateInterface $form_state, $form_id) {
  // Only run on the final step: this one has 'entity' not 'entity_browser'.
  if (!isset($form['entity'])) {
    return;
  }

  // Figure out the entity type from the attributes.
  $entity_type_value = NULL;
  if (isset($form['attributes']['data-entity-type']['#value'])) {
    $entity_type_value = $form['attributes']['data-entity-type']['#value'];
  }

  // Only touch block_content embeds at all.
  if ($entity_type_value !== 'block_content') {
    return;
  }
  $entity_element = $form_state->get('entity_element');

  // Remove Align and Caption if present on this step.
  if (isset($form['attributes']['data-align'])) {
    unset($form['attributes']['data-align']);
  }
  if (isset($form['attributes']['data-caption'])) {
    unset($form['attributes']['data-caption']);
  }

  // Load the selected block by UUID and limit to the 'webform' bundle.
  $uuid = $form['attributes']['data-entity-uuid']['#value'] ?? NULL;
  if (!$uuid) {
    return;
  }
  $blocks = \Drupal::entityTypeManager()
    ->getStorage('block_content')
    ->loadByProperties(['uuid' => $uuid]);
  $block = $blocks ? reset($blocks) : NULL;

  // Add Title -> data-block-title.
  $form['attributes']['data-block-title'] = [
    '#type' => 'textfield',
    '#title' => t('Title'),
    '#description' => t('Optional title shown above this embedded block on this page only.'),
    '#maxlength' => 255,
    '#weight' => 10,
    '#default_value' => isset($entity_element['data-block-title']) ? Html::decodeEntities($entity_element['data-block-title']) : '',
  ];

  $options = [
    '' => t('- None -'),
    'Border' => t('Border'),
  ];

  if ($block && $block->bundle() == 'webform') {
    $options['Blue'] = t('Blue');
    $options['Green'] = t('Green');
    $options['Teal'] = t('Teal');
  }

  // Add Style -> data-style-attribute.
  $form['attributes']['data-style-attribute'] = [
    '#type' => 'select',
    '#title' => t('Style'),
    '#options' => $options,
    '#description' => t('Choose a per-embed style variant. “Border” matches the CKEditor Bulleted list border look.'),
    '#weight' => 11,
    '#default_value' => isset($entity_element['data-style-attribute']) ? $entity_element['data-style-attribute'] : '',
  ];
}
